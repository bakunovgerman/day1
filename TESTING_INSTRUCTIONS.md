# Инструкция по тестированию механизма сжатия контекста

## Подготовка к тестированию

1. Убедитесь, что в `local.properties` настроен `OPENROUTER_API_KEY`
2. Соберите и запустите приложение
3. Откройте экран чата

## Сценарий тестирования

### Тест 1: Базовая функциональность

1. **Включите сжатие контекста**
   - Нажмите на иконку настроек (шестеренка)
   - Найдите переключатель "Сжатие контекста"
   - Включите его
   - Должна появиться информационная подсказка: "✨ При достижении 11 сообщений будет создано краткое резюме..."

2. **Отправьте 11 сообщений** (5-6 пар вопрос-ответ)
   - Ведите диалог с AI, отправляя различные вопросы
   - Дождитесь, пока в истории накопится 11 сообщений
   - **При достижении 11-го сообщения** автоматически генерируется summary

3. **Проверьте генерацию summary**
   - При достижении 11-го сообщения должен автоматически сгенерироваться summary
   - Вы увидите зеленый снэкбар с индикатором загрузки
   - Текущий и следующие запросы должны использовать сжатый контекст
   - В логах (Logcat) можно увидеть запрос на генерацию summary

4. **Проверьте работу с сжатым контекстом**
   - Отправьте новое сообщение: "Можешь напомнить, о чем мы говорили?"
   - AI должен ответить на основе summary, а не полной истории
   - Все предыдущие сообщения должны оставаться видимыми в UI

### Тест 2: Отключение сжатия

1. **Отключите сжатие контекста**
   - Откройте настройки
   - Выключите "Сжатие контекста"
   - Summary должен быть сброшен

2. **Отправьте новое сообщение**
   - Убедитесь, что теперь отправляется полная история диалога

### Тест 3: Очистка чата

1. **Очистите чат**
   - Нажмите на иконку очистки (крестик)
   - Все сообщения должны быть удалены
   - Summary должен быть сброшен

2. **Начните новый диалог**
   - Включите сжатие контекста
   - Отправьте 11 новых сообщений (5-6 пар)
   - Summary должен быть сгенерирован заново

### Тест 4: Проверка UI

1. **Проверьте видимость всех сообщений**
   - После включения сжатия и отправки 11+ сообщений
   - Все сообщения должны оставаться видимыми в списке
   - Можно прокручивать историю вверх и вниз

2. **Проверьте метрики**
   - После генерации summary следующие запросы должны иметь меньше prompt tokens
   - Проверьте в информации о сообщении (время, токены, стоимость)

## Ожидаемые результаты

### До сжатия (первые 10 сообщений)
- Отправляется: system prompt + вся история диалога + текущее сообщение
- Prompt tokens: высокое значение (растет с каждым сообщением)

### При 11-м сообщении
- Генерируется summary всех 11 сообщений
- Появляется зеленый снэкбар с индикатором загрузки
- Может занять несколько секунд
- После генерации отправляется: system prompt + summary + текущее сообщение

### После сжатия (12+ сообщений)
- Отправляется: system prompt + summary + только текущее сообщение
- Prompt tokens: низкое значение (фиксированное)
- Экономия токенов: значительная (~84%)
- Каждые 11 сообщений (при 22, 33 и т.д.) генерируется новый summary

## Проверка логов

Для детальной проверки используйте Android Studio Logcat:

```
# Фильтр для OpenRouterService
Tag: OpenRouterService

# Что искать:
- "Error generating summary" - ошибка генерации summary
- Статистика токенов для каждого запроса
- Время ответа
```

## Известные особенности

1. Summary генерируется каждые 11 сообщений (при 11, 22, 33 и т.д.)
2. После генерации summary все последующие запросы используют его (до следующей генерации)
3. Summary обновляется автоматически каждые 11 сообщений
4. При очистке чата или выключении сжатия summary сбрасывается
5. Температура для генерации summary = 1.0 (более естественный результат)

## Возможные проблемы

### Проблема: Summary не генерируется
**Решение**: 
- Проверьте, что сжатие контекста включено
- Убедитесь, что отправлено кратное 11 количество сообщений (11, 22, 33...)
- Проверьте наличие API ключа

### Проблема: AI не помнит контекст после сжатия
**Решение**:
- Это ожидаемое поведение - AI использует только summary
- Summary содержит краткую информацию о диалоге
- Для полного контекста отключите сжатие

### Проблема: Ошибка при генерации summary
**Решение**:
- Проверьте подключение к интернету
- Проверьте лимиты API ключа
- Посмотрите детали ошибки в Logcat

## Рекомендации по тестированию

1. Тестируйте с разным количеством сообщений
2. Проверьте работу с длинными и короткими сообщениями
3. Убедитесь, что UI остается отзывчивым
4. Проверьте экономию токенов по метрикам
5. Тестируйте переключение режима во время диалога
