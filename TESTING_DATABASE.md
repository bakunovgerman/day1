# Тестирование функционала базы данных

## Подготовка к тестированию

### 1. Синхронизация проекта
После внесения изменений необходимо:
1. Открыть проект в Android Studio
2. Нажать "Sync Project with Gradle Files" (иконка слона вверху справа)
3. Дождаться завершения синхронизации

### 2. Сборка проекта
```bash
./gradlew clean build
```

## Сценарии тестирования

### Сценарий 1: Сохранение и восстановление истории чата

**Цель:** Проверить, что история чата сохраняется в БД и восстанавливается при перезапуске

**Шаги:**
1. Запустить приложение
2. Отправить несколько сообщений (3-5)
3. Получить ответы от ассистента
4. Закрыть приложение (полностью завершить процесс)
5. Снова запустить приложение

**Ожидаемый результат:**
- Все сообщения отображаются в том же порядке
- Счетчик токенов показывает правильное значение

### Сценарий 2: Очистка чата

**Цель:** Проверить, что БД очищается при очистке чата

**Шаги:**
1. Запустить приложение с существующей историей
2. Нажать кнопку "Очистить чат"
3. Проверить, что все сообщения удалены
4. Перезапустить приложение

**Ожидаемый результат:**
- Список сообщений пуст
- Счетчик токенов равен 0
- После перезапуска история остается пустой

### Сценарий 3: Суммаризация и флаг needSend

**Цель:** Проверить, что суммаризация работает и сообщения помечаются как needSend=false

**Шаги:**
1. Запустить приложение
2. Включить "Context Compression"
3. Отправить 11 сообщений (чередуя вопросы и ответы)
4. Дождаться генерации суммаризации
5. Отправить еще одно сообщение
6. Проверить логи (в Android Studio Logcat)

**Ожидаемый результат:**
- После 11-го сообщения генерируется суммаризация
- Появляется индикатор "Generating summary..."
- Следующий запрос к LLM содержит только новые сообщения + summary в system prompt
- Старые сообщения не отправляются повторно

### Сценарий 4: Множественные сессии

**Цель:** Проверить стабильность работы БД при множественных перезапусках

**Шаги:**
1. Запустить приложение
2. Отправить 2-3 сообщения
3. Перезапустить приложение
4. Отправить еще 2-3 сообщения
5. Повторить пункты 3-4 несколько раз
6. Проверить целостность истории

**Ожидаемый результат:**
- История сохраняется корректно
- Порядок сообщений правильный
- Нет дублирования сообщений
- Все метаданные (токены, стоимость, время ответа) сохранены

## Проверка данных в БД

### Используя Database Inspector (Android Studio)

1. Запустить приложение на эмуляторе/устройстве
2. В Android Studio: View → Tool Windows → App Inspection
3. Выбрать вкладку "Database Inspector"
4. Выбрать процесс приложения
5. Открыть базу данных "chat_database"
6. Просмотреть таблицы:
   - **chat_messages** - все сообщения
   - **summaries** - суммаризации

### Что проверять в таблице chat_messages:

- Поле `needSend`:
  - `1` (true) для новых сообщений
  - `0` (false) для сообщений, покрытых суммаризацией
  
- Поле `timestamp` - правильный порядок сообщений

- Поля `tokensUsed`, `promptTokens`, `completionTokens`, `cost` - заполнены для сообщений ассистента

### Что проверять в таблице summaries:

- Поле `isCurrent`:
  - `1` (true) только у последней суммаризации
  - `0` (false) у всех предыдущих
  
- Поле `summary` содержит текст суммаризации

- Поля токенов и cost заполнены

## Отладка проблем

### Проблема: История не сохраняется

**Возможные причины:**
1. БД не инициализирована
2. Ошибки при сохранении

**Решение:**
- Проверить логи на наличие ошибок Room
- Убедиться, что метод `chatRepository.saveMessage()` вызывается
- Проверить права доступа к файловой системе

### Проблема: Дублирование сообщений

**Возможные причины:**
1. Flow собирается несколько раз
2. Сообщения добавляются и в БД, и в StateFlow

**Решение:**
- Убедиться, что сообщения добавляются только в БД
- Flow автоматически обновит UI

### Проблема: Суммаризация не работает

**Возможные причины:**
1. Context Compression не включен
2. Недостаточно сообщений (меньше 11)
3. Ошибка API при генерации summary

**Решение:**
- Проверить флаг `_useContextCompression`
- Проверить логи на наличие ошибок API
- Убедиться, что API ключ валиден

## Логирование для отладки

Можно добавить логи в `ChatRepository.kt`:

```kotlin
suspend fun saveMessage(message: ChatMessage) {
    Log.d("ChatRepository", "Saving message: ${message.id}, needSend=${message.needSend}")
    chatMessageDao.insertMessage(message.toEntity())
}

suspend fun saveSummary(summaryResponse: SummaryResponse) {
    Log.d("ChatRepository", "Saving summary and marking messages as not needed")
    summaryDao.markAllSummariesAsNotCurrent()
    // ...
    markAllMessagesAsNotNeeded()
    Log.d("ChatRepository", "All messages marked as needSend=false")
}
```

## Метрики успешности

### ✅ Тестирование пройдено успешно, если:

1. ✅ История чата восстанавливается после перезапуска
2. ✅ Очистка чата полностью удаляет данные из БД
3. ✅ Суммаризация генерируется каждые 11 сообщений
4. ✅ Флаг `needSend` правильно устанавливается
5. ✅ Старые сообщения не отправляются в LLM после суммаризации
6. ✅ UI обновляется автоматически при изменениях в БД
7. ✅ Нет дублирования сообщений
8. ✅ Метаданные (токены, стоимость) сохраняются корректно
9. ✅ Счетчик токенов работает правильно
10. ✅ Нет падений приложения и ошибок в логах
