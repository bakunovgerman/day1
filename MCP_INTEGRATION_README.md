# MCP Tool Calling Integration โ

## ะงัะพ ัะดะตะปะฐะฝะพ

ะะตะฐะปะธะทะพะฒะฐะฝะฐ **ะฟะพะปะฝะฐั ะธะฝัะตะณัะฐัะธั MCP (Model Context Protocol)** ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะฒัะทะพะฒะฐ ะฒะฝะตัะฝะธั tools ัะตัะตะท LLM.

## ๐ฏ ะัะฝะพะฒะฝะพะน ััะฝะบัะธะพะฝะฐะป

### 1. ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะพะปััะตะฝะธะต tools ะพั MCP ัะตัะฒะตัะฐ
ะัะธ ะทะฐะฟััะบะต ะฟัะธะปะพะถะตะฝะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ:
- ะะพะดะบะปััะฐะตััั ะบ MCP ัะตัะฒะตัั: `https://fittable-deeanna-noneditorially.ngrok-free.dev/mcp`
- ะะพะปััะฐะตั ัะฟะธัะพะบ ะดะพัััะฟะฝัั tools
- ะะพะฝะฒะตััะธััะตั ะธั ะฒ ัะพัะผะฐั OpenAI

### 2. ะะตัะตะดะฐัะฐ tools ะฒ ะทะฐะฟัะพัั ะบ LLM
ะะฐะถะดัะน ะทะฐะฟัะพั ะบ LLM ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒะบะปััะฐะตั:
- ะกะฟะธัะพะบ ะฒัะตั ะดะพัััะฟะฝัั tools
- ะั ะพะฟะธัะฐะฝะธั ะธ ะฟะฐัะฐะผะตััั
- ะคะพัะผะฐั ะฒัะทะพะฒะฐ

### 3. ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะทะพะฒ tools
ะะพะณะดะฐ LLM ะฒะพะทะฒัะฐัะฐะตั tool_call:
- ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฟะพะปะฝัะตััั ัะตัะตะท MCP ะบะปะธะตะฝั
- ะะตะทัะปััะฐั ะพัะฟัะฐะฒะปัะตััั ะพะฑัะฐัะฝะพ ะฒ LLM
- LLM ัะพัะผะธััะตั ัะธะฝะฐะปัะฝัะน ะพัะฒะตั ะฟะพะปัะทะพะฒะฐัะตะปั

### 4. ะะพะดะดะตัะถะบะฐ ัะตะฟะพัะตะบ tool calls
LLM ะผะพะถะตั ะฒัะทะฒะฐัั ะฝะตัะบะพะปัะบะพ tools ะฟะพะดััะด:
- Tool 1 โ Result 1 โ Tool 2 โ Result 2 โ Final answer
- ะะพ 5 ะธัะตัะฐัะธะน (ะทะฐัะธัะฐ ะพั ะฑะตัะบะพะฝะตัะฝัั ัะธะบะปะพะฒ)

## ๐ ะะทะผะตะฝะตะฝะฝัะต ัะฐะนะปั

### 1. `app/src/main/java/com/example/day1/data/ChatMessage.kt`
**ะะพะฑะฐะฒะปะตะฝะพ:**
- ะะพะดะตะปะธ ะดะฐะฝะฝัั ะดะปั tool calling: `ToolDefinition`, `ToolCall`, `FunctionCall`
- ะะพะดะดะตัะถะบะฐ tool_calls ะฒ `MessageContent` ะธ `MessageResponse`
- ะะพะดะดะตัะถะบะฐ tools ะฒ `OpenRouterRequest`

### 2. `app/src/main/java/com/example/day1/api/OpenRouterService.kt`
**ะะทะผะตะฝะตะฝะพ:**
- `sendMessageToMultipleModels()` - ะฟัะธะฝะธะผะฐะตั ะฟะฐัะฐะผะตัั `tools`
- `sendMessageToModel()` - ะฟะตัะตะดะฐะตั tools ะฒ API ะทะฐะฟัะพั
- ะะพะทะฒัะฐัะฐะตั tool_calls ะธะท ะพัะฒะตัะฐ LLM

### 3. `app/src/main/java/com/example/day1/viewmodel/ChatViewModel.kt`
**ะะพะฑะฐะฒะปะตะฝะพ:**
- ะะฝะธัะธะฐะปะธะทะฐัะธั MCP ะบะปะธะตะฝัะฐ
- ะะฐะณััะทะบะฐ tools ะฟัะธ ััะฐััะต (`loadMcpTools()`)
- ะฆะธะบะป tool calling (`sendMessageWithToolCalling()`)
- ะัะฟะพะปะฝะตะฝะธะต tools (`executeToolCall()`)
- ะะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต

## ๐ ะะฐะบ ะธัะฟะพะปัะทะพะฒะฐัั

### ะะฑััะฝัะน ัะตะถะธะผ ัะฐะฑะพัั
ะัะพััะพ ะธัะฟะพะปัะทัะนัะต ะฟัะธะปะพะถะตะฝะธะต ะบะฐะบ ัะฐะฝััะต - ะฝะธัะตะณะพ ะฝะต ะธะทะผะตะฝะธะปะพัั!

### ะะพะณะดะฐ ะฝัะถะฝั tools
ะัะฟัะฐะฒััะต ัะพะพะฑัะตะฝะธะต, ััะตะฑัััะตะต ะฒะฝะตัะฝะธั ะดะฐะฝะฝัั:

**ะัะธะผะตัั:**
```
"What's the current date?"
"Search for information about Kotlin"
"Calculate 123 * 456"
"What's the weather in Moscow?"
```

LLM ะฐะฒัะพะผะฐัะธัะตัะบะธ:
1. ะะฟัะตะดะตะปะธั, ะฝัะถะตะฝ ะปะธ tool
2. ะัะทะพะฒะตั ะฝัะถะฝัะน tool ัะตัะตะท MCP
3. ะะพะปััะธั ัะตะทัะปััะฐั
4. ะกัะพัะผะธััะตั ะพัะฒะตั

### ะัะพะฒะตัะบะฐ ัะฐะฑะพัั

**ะจะฐะณ 1:** ะะฐะฟัััะธัะต ะฟัะธะปะพะถะตะฝะธะต

**ะจะฐะณ 2:** ะัะบัะพะนัะต Logcat ะธ ะพััะธะปััััะนัะต ะฟะพ `ChatViewModel`

**ะจะฐะณ 3:** ะัะพะฒะตัััะต ะปะพะณะธ:
```
D/ChatViewModel: Loaded 3 tools from MCP
D/ChatViewModel:   - get_current_date: Returns the current date
D/ChatViewModel:   - web_search: Search the web
D/ChatViewModel:   - calculate: Perform calculations
```

**ะจะฐะณ 4:** ะัะฟัะฐะฒััะต ัะตััะพะฒะพะต ัะพะพะฑัะตะฝะธะต

**ะจะฐะณ 5:** ะัะพะฒะตัััะต ะปะพะณะธ tool calling:
```
D/ChatViewModel: Tool calling iteration 1
D/ChatViewModel: Model GPT-4o-mini requested 1 tool calls
D/ChatViewModel: Executing tool: get_current_date
D/ChatViewModel: Tool result: 2026-02-01
```

## ๐ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ
โ   User UI   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        ChatViewModel                โ
โ                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ   Tool Calling Loop          โ  โ
โ  โ                              โ  โ
โ  โ  1. Send to LLM with tools  โ  โ
โ  โ  2. Get response             โ  โ
โ  โ  3. Has tool_calls?          โ  โ
โ  โ     โโ No โ Save & show      โ  โ
โ  โ     โโ Yes โ                 โ  โ
โ  โ        โ                      โ  โ
โ  โ  4. Execute via MCP          โ  โ
โ  โ  5. Add results              โ  โ
โ  โ  6. Loop (max 5 iter)        โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโ
   โ                            โ
   โ                            โ
โโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
โ OpenRouter   โ      โ  MCP Client  โ
โ   LLM API    โ      โ              โ
โโโโโโโโโโโโโโโโ      โโโโโโโโฌโโโโโโโโ
                             โ
                             โ
                      โโโโโโโโโโโโโโโโ
                      โ  MCP Server  โ
                      โ    (ngrok)   โ
                      โโโโโโโโโโโโโโโโ
```

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### MCP Server URL
ะ `ChatViewModel.kt`:
```kotlin
val mcpClient = McpClient(
    config = McpConfig(
        url = "https://fittable-deeanna-noneditorially.ngrok-free.dev/mcp"
    )
)
```

### ะะฐะบัะธะผัะผ ะธัะตัะฐัะธะน tool calling
```kotlin
private val maxToolCallIterations = 5
```

### ะะพัััะฟะฝัะต tools
ะัะพะฒะตัััััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะตัะตะท `mcpClient.listTools()`

## ๐ ะะตะทะพะฟะฐัะฝะพััั

โ **ะะตะฐะปะธะทะพะฒะฐะฝะพ:**
- ะะฐะบัะธะผัะผ 5 ะธัะตัะฐัะธะน (ะทะฐัะธัะฐ ะพั ะฑะตัะบะพะฝะตัะฝัั ัะธะบะปะพะฒ)
- Try-catch ะฝะฐ ะฒัะตั tool calls (ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ)
- ะะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะพะฟะตัะฐัะธะน
- Graceful degradation (ะตัะปะธ MCP ะฝะตะดะพัััะฟะตะฝ - ัะฐะฑะพัะฐะตั ะฑะตะท tools)

โ๏ธ **ะัะธะผะตัะฐะฝะธั:**
- Tools ะฒัะฟะพะปะฝััััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฑะตะท ะฟะพะดัะฒะตัะถะดะตะฝะธั
- ะะตั rate limiting ะฝะฐ ะฒัะทะพะฒั tools
- ะะตะทัะปััะฐัั ะฝะต ะบััะธัััััั

## ๐ ะะพะณะธัะพะฒะฐะฝะธะต

ะัะต ะพะฟะตัะฐัะธะธ ะปะพะณะธัััััั ั ัะตะณะพะผ `ChatViewModel`:

```kotlin
// ะัะธ ะทะฐะณััะทะบะต tools
"Loaded X tools from MCP"
"  - tool_name: description"

// ะัะธ tool calling
"Tool calling iteration N"
"Model X requested Y tool calls"
"Executing tool: tool_name"
"Arguments: {...}"
"Tool result: ..."

// ะัะธ ะพัะธะฑะบะฐั
"Failed to load MCP tools: error"
"Error executing tool: error"
```

## ๐ ะัะปะฐะดะบะฐ

### Tools ะฝะต ะทะฐะณััะถะฐัััั
1. ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั MCP ัะตัะฒะตัะฐ
2. ะัะพะฒะตัััะต ngrok tunnel
3. ะัะพะฒะตัััะต ะปะพะณะธ ะฝะฐ ะพัะธะฑะบะธ

### LLM ะฝะต ะฒัะทัะฒะฐะตั tools
1. ะฃะฑะตะดะธัะตัั ััะพ tools ะทะฐะณััะถะตะฝั (ะฟัะพะฒะตัััะต ะปะพะณะธ)
2. ะกะดะตะปะฐะนัะต ะทะฐะฟัะพั ะฑะพะปะตะต ัะฒะฝัะผ
3. ะัะพะฒะตัััะต ััะพ tools ะบะพััะตะบัะฝะพ ะพะฟัะตะดะตะปะตะฝั

### ะัะธะฑะบะธ ะฒัะฟะพะปะฝะตะฝะธั tools
1. ะัะพะฒะตัััะต ัะพัะผะฐั ะฐัะณัะผะตะฝัะพะฒ tool
2. ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั MCP ัะตัะฒะตัะฐ
3. ะัะพะฒะตัััะต ะปะพะณะธ MCP ัะตัะฒะตัะฐ

## ๐ ะะพะบัะผะตะฝัะฐัะธั

- **MCP_TOOL_CALLING_IMPLEMENTATION.md** - ะฟะพะปะฝะฐั ัะตัะฝะธัะตัะบะฐั ะดะพะบัะผะตะฝัะฐัะธั
- **MCP_QUICK_START.md** - ะฑัััััะน ััะฐัั ะธ ะฟัะธะผะตัั
- **MCP_CHANGES_SUMMARY.md** - ะดะตัะฐะปัะฝัะน ัะฟะธัะพะบ ะธะทะผะตะฝะตะฝะธะน

## โ ะขะตััะธัะพะฒะฐะฝะธะต

### ะะฐะทะพะฒัะน ัะตัั
```
User: "What's the date today?"
Expected: LLM ะฒัะทะพะฒะตั get_current_date tool ะธ ะฒะตัะฝะตั ะดะฐัั
```

### ะขะตัั ัะตะฟะพัะบะธ
```
User: "Search for Kotlin and count the words"
Expected: 
1. LLM ะฒัะทะพะฒะตั web_search tool
2. ะะฐัะตะผ ะฒัะทะพะฒะตั word_count tool
3. ะะตัะฝะตั ัะธะฝะฐะปัะฝัะน ัะตะทัะปััะฐั
```

### ะขะตัั ะฑะตะท tools
```
User: "Hello, how are you?"
Expected: ะะฑััะฝัะน ะพัะฒะตั ะฑะตะท ะฒัะทะพะฒะฐ tools
```

## ๐จ ะงัะพ ะะ ะธะทะผะตะฝะธะปะพัั

โ **ะะพะปะฝะฐั ะพะฑัะฐัะฝะฐั ัะพะฒะผะตััะธะผะพััั:**
- UI ะพััะฐะปัั ะฟัะตะถะฝะธะผ
- ะะ ััััะบัััะฐ ะฝะต ะธะทะผะตะฝะธะปะฐัั
- API ะบะปััะธ ัะต ะถะต
- ะัะต ะฝะฐัััะพะนะบะธ ัะฐะฑะพัะฐัั ะบะฐะบ ัะฐะฝััะต
- ะัะปะธ tools ะฝะตะดะพัััะฟะฝั - ัะฐะฑะพัะฐะตั ะฒ ะพะฑััะฝะพะผ ัะตะถะธะผะต

## ๐ง ะกะปะตะดัััะธะต ัะฐะณะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### ะฃะปัััะตะฝะธั UX:
1. ะะพะฑะฐะฒะธัั UI ะธะฝะดะธะบะฐัะพั "Executing tool..."
2. ะะพะบะฐะทัะฒะฐัั ะบะฐะบะพะน tool ะฒัะฟะพะปะฝัะตััั
3. ะััะพัะธั tool calls ะฒ UI
4. ะะฐัััะพะนะบะฐ ะฒะบะปััะตะฝะธั/ะฒัะบะปััะตะฝะธั tools

### ะฃะปัััะตะฝะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ:
1. ะััะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ tools
2. Parallel execution ะฝะตะทะฐะฒะธัะธะผัั tools
3. Retry ะฟะพะปะธัะธะบะฐ ะดะปั failed tools

### ะฃะปัััะตะฝะธั ะฑะตะทะพะฟะฐัะฝะพััะธ:
1. User confirmation ะดะปั ะบัะธัะธัะฝัั tools
2. Rate limiting ะฝะฐ ะฒัะทะพะฒั
3. Whitelist/blacklist tools
4. ะะฐะปะธะดะฐัะธั ะฐัะณัะผะตะฝัะพะฒ

## ๐ก ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะัะพััะพะน tool call
```
User: "What time is it?"
โ LLM: [tool_call: get_current_time()]
โ MCP: "14:30:45"
โ LLM: "It's 2:30:45 PM"
```

### ะฆะตะฟะพัะบะฐ tool calls
```
User: "Find the latest Kotlin news and summarize it"
โ LLM: [tool_call: web_search("Kotlin news")]
โ MCP: "Article text..."
โ LLM: [tool_call: summarize("Article text...")]
โ MCP: "Summary: Kotlin 2.0 released..."
โ LLM: "Here's the latest: Kotlin 2.0 has been released with..."
```

### ะะฝะพะถะตััะฒะตะฝะฝัะต tools
```
User: "Compare weather in Moscow and New York"
โ LLM: [tool_call: get_weather("Moscow"), get_weather("New York")]
โ MCP: "Moscow: 5ยฐC", "New York: 10ยฐC"
โ LLM: "Moscow is 5ยฐC and New York is 10ยฐC. New York is warmer."
```

## ๐ ะะพัะพะฒะพ!

ะะฝัะตะณัะฐัะธั MCP Tool Calling ะฟะพะปะฝะพัััั ัะตะฐะปะธะทะพะฒะฐะฝะฐ ะธ ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั.

**ะงัะพะฑั ะฝะฐัะฐัั:**
1. ะฃะฑะตะดะธัะตัั ััะพ MCP ัะตัะฒะตั ะดะพัััะฟะตะฝ
2. ะะฐะฟัััะธัะต ะฟัะธะปะพะถะตะฝะธะต
3. ะัะพะฒะตัััะต ะปะพะณะธ
4. ะัะฟัะฐะฒััะต ัะตััะพะฒะพะต ัะพะพะฑัะตะฝะธะต

**ะะพะฟัะพัั?** ะกะผะพััะธัะต ะฟะพะปะฝัั ะดะพะบัะผะตะฝัะฐัะธั ะฒ ะดััะณะธั MD ัะฐะนะปะฐั.

---

**ะะฒัะพั:** AI Assistant  
**ะะฐัะฐ:** 2026-02-01  
**ะะตััะธั:** 1.0.0
