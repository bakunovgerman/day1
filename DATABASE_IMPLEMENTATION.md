# Реализация хранения истории чата в Room Database

## Обзор изменений

Добавлена полная интеграция Room Database для хранения истории чата с поддержкой суммаризации и оптимизации отправки сообщений в LLM.

## Архитектура

### 1. База данных

#### Таблицы:

**chat_messages** - хранит все сообщения чата
- `id` (String, PK) - уникальный идентификатор сообщения
- `role` (String) - роль ("user" или "assistant")
- `content` (String) - содержимое сообщения
- `title`, `body`, `tags` - дополнительные поля для структурированных ответов
- `temperature`, `modelName`, `responseTimeMs`, etc. - метаданные модели
- `tokensUsed`, `promptTokens`, `completionTokens`, `cost` - метрики использования
- `timestamp` (Long) - время создания
- **`needSend` (Boolean)** - флаг, указывающий нужно ли отправлять сообщение в LLM

**summaries** - хранит суммаризации диалога
- `id` (Long, PK, autoGenerate) - идентификатор
- `summary` (String) - текст суммаризации
- `promptTokens`, `completionTokens`, `totalTokens` - метрики токенов
- `cost` (Double) - стоимость генерации суммаризации
- `timestamp` (Long) - время создания
- `isCurrent` (Boolean) - флаг текущей активной суммаризации

### 2. Компоненты

#### Entities (db/entity/)
- `ChatMessageEntity.kt` - сущность для сообщений чата
- `SummaryEntity.kt` - сущность для суммаризаций

#### DAO (db/dao/)
- `ChatMessageDao.kt` - методы доступа к сообщениям
  - `getAllMessages()` - получение всех сообщений (Flow для автообновления UI)
  - `getMessagesForSending()` - получение сообщений с needSend=true
  - `markAllMessagesAsNotNeeded()` - установка needSend=false для всех сообщений
  - `deleteAll()` - очистка таблицы

- `SummaryDao.kt` - методы доступа к суммаризациям
  - `getCurrentSummary()` - получение текущей активной суммаризации
  - `markAllSummariesAsNotCurrent()` - деактивация всех суммаризаций
  - `deleteAll()` - очистка таблицы

#### Database
- `AppDatabase.kt` - главный класс базы данных
- `Converters.kt` - конвертеры для хранения списков (tags) в виде JSON

#### Repository
- `ChatRepository.kt` - слой абстракции между ViewModel и DAO
  - Конвертация между ChatMessage и ChatMessageEntity
  - Автоматическое управление флагом needSend при сохранении суммаризации
  - Управление жизненным циклом суммаризаций

### 3. Логика работы

#### При запуске приложения:
1. ChatViewModel инициализирует базу данных и репозиторий
2. Метод `loadChatHistory()` подписывается на изменения в БД через Flow
3. Загружается текущая суммаризация (если есть)
4. UI автоматически обновляется при изменениях в БД

#### При отправке сообщения:
1. Сообщение пользователя сохраняется в БД (с needSend=true)
2. Проверяется условие для генерации суммаризации (каждые 11 сообщений)
3. Если нужна суммаризация:
   - Генерируется summary всех предыдущих сообщений
   - Summary сохраняется в таблицу summaries
   - Все сообщения помечаются как needSend=false
4. Формируется контекст для отправки в LLM:
   - Если есть суммаризация: отправляются только сообщения с needSend=true + summary в system prompt
   - Если нет суммаризации: отправляются все сообщения
5. Ответ ассистента сохраняется в БД (с needSend=true)

#### При очистке чата:
1. Вызывается `chatRepository.clearAllData()`
2. Удаляются все сообщения из таблицы chat_messages
3. Удаляются все суммаризации из таблицы summaries
4. Сбрасываются счетчики токенов

## Преимущества реализации

### 1. Персистентность данных
- История чата сохраняется между сессиями
- Данные переживают перезапуск приложения
- Защита от потери данных при сворачивании приложения

### 2. Оптимизация работы с LLM
- Флаг `needSend` предотвращает отправку старых сообщений, покрытых суммаризацией
- Снижение количества токенов в запросах
- Сокращение времени ответа и стоимости использования API

### 3. Реактивное обновление UI
- Использование Flow обеспечивает автоматическое обновление UI
- Изменения в БД мгновенно отражаются в интерфейсе
- Нет необходимости в ручной синхронизации состояния

### 4. Масштабируемость
- Легко добавлять новые поля в таблицы
- Простая миграция схемы БД
- Возможность добавления новых таблиц для расширения функционала

### 5. Разделение ответственности
- Repository изолирует логику работы с БД
- ViewModel не знает о деталях хранения данных
- Легкость тестирования и поддержки кода

## Зависимости

Добавлены следующие зависимости в `build.gradle.kts`:

```kotlin
// Room
implementation(libs.androidx.room.runtime)
implementation(libs.androidx.room.ktx)
ksp(libs.androidx.room.compiler)
```

И в `libs.versions.toml`:

```toml
[versions]
room = "2.6.1"

[libraries]
androidx-room-runtime = { group = "androidx.room", name = "room-runtime", version.ref = "room" }
androidx-room-ktx = { group = "androidx.room", name = "room-ktx", version.ref = "room" }
androidx-room-compiler = { group = "androidx.room", name = "room-compiler", version.ref = "room" }

[plugins]
ksp = { id = "com.google.devtools.ksp", version = "2.0.21-1.0.28" }
```

## Использование

### Автоматическая работа
Все операции с БД происходят автоматически:
- Сообщения сохраняются при отправке
- История загружается при запуске
- БД очищается при нажатии кнопки "Очистить чат"

### Отладка
Для просмотра данных в БД можно использовать:
- Android Studio Database Inspector
- Команды SQL через DAO методы
- Логирование в репозитории

## Будущие улучшения

Возможные направления развития:
1. Экспорт/импорт истории чата
2. Поиск по истории сообщений
3. Фильтрация сообщений по модели/дате
4. Статистика использования токенов
5. Управление множественными чатами
6. Синхронизация с облаком
