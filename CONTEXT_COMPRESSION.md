# Механизм сжатия истории диалога

## Описание
Реализован механизм автоматического сжатия истории диалога для оптимизации использования токенов при работе с AI моделями.

## Основные возможности

### 1. Автоматическое сжатие контекста
- При отправке **11-го сообщения** (после 5-6 пар вопрос-ответ) автоматически генерируется краткое резюме (summary)
- Summary создается через OpenRouterService с использованием модели `openai/gpt-4o-mini`
- Temperature для генерации summary = 1.0 (для естественного и связного результата)
- Summary включает все 11 сообщений (10 предыдущих + текущее)

### 2. Оптимизация токенов
После генерации summary:
- В API отправляется только **summary + текущее сообщение пользователя**
- Вся предыдущая история диалога **не отправляется**, экономя токены
- Summary добавляется в system prompt как контекст предыдущего диалога

### 3. Сохранение истории в UI
- **Все сообщения остаются видимыми** в интерфейсе чата
- Пользователь может видеть полную историю диалога
- Сжатие влияет только на данные, отправляемые в API

### 4. Управление через настройки
В меню настроек (`SystemPromptDialog`) добавлен переключатель:
- **"Сжатие контекста"** - включение/выключение механизма
- При выключении summary сбрасывается
- При очистке чата summary также сбрасывается

## Технические детали

### Промпт для генерации summary
```
System: Ты - эксперт по сжатию диалогов. Твоя задача - создать краткое, лаконичное резюме диалога на русском языке, сохраняя ключевую информацию, контекст и важные детали.

User: Создай краткое резюме следующего диалога, выделив ключевые темы, решения и важную информацию:
[текст всех сообщений]

Резюме должно быть кратким (2-4 предложения) и содержать только самое важное.
```

### Логика работы

1. **До 11 сообщений**: отправляется полная история диалога
2. **При 11 сообщениях** (5-6 пар вопрос-ответ): 
   - Генерируется summary всех 11 сообщений
   - Отправляется: system prompt + summary + только текущее (11-е) сообщение
3. **После 11 сообщений**: 
   - Каждые 11 сообщений (при 22, 33, 44 и т.д.) генерируется новый summary
   - Отправляется: system prompt + summary + только текущее сообщение
   - Предыдущие сообщения не отправляются

### Модифицированные файлы

#### 1. `OpenRouterService.kt`
Добавлена функция `generateSummary()`:
- Принимает текст всех сообщений диалога
- Отправляет запрос к LLM для создания краткого резюме
- Возвращает сжатый контекст

#### 2. `ChatViewModel.kt`
Добавлены:
- `_useContextCompression`: состояние включения/выключения сжатия
- `contextSummary`: хранение сгенерированного резюме
- `toggleContextCompression()`: функция переключения режима
- Обновлена логика `sendMessage()` для работы со сжатием
- Обновлена `clearChat()` для сброса summary

#### 3. `ChatScreen.kt`
Добавлены:
- `useContextCompression` в состояние экрана
- Параметр в `SystemPromptDialog`
- Переключатель UI для включения/выключения сжатия
- Информационное сообщение о работе механизма

## Преимущества

1. **Экономия токенов**: значительное снижение количества отправляемых токенов
2. **Снижение стоимости**: меньше токенов = меньше затрат на API
3. **Сохранение контекста**: summary содержит ключевую информацию
4. **Гибкость**: можно включать/выключать по необходимости
5. **Прозрачность**: все сообщения видны пользователю

## Использование

1. Откройте настройки (иконка шестеренки)
2. Включите переключатель **"Сжатие контекста"**
3. Ведите диалог как обычно
4. После 5-6 пар вопрос-ответ, при отправке 11-го сообщения автоматически создастся summary
5. Каждые 11 сообщений будет генерироваться новый summary
6. Текущий и следующие запросы будут использовать сжатый контекст

## Примечания

- Summary генерируется каждые 11 сообщений (при 11, 22, 33 и т.д.)
- При очистке чата summary сбрасывается
- При выключении сжатия summary также сбрасывается
- Механизм не влияет на отображение сообщений в UI
- Проверка: 11 сообщений в истории → генерация summary
